<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Banerjee Mart - Admin Panel</title>
  <style>
    /* Reset & base */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: #f9fafb;
      color: #222;
      line-height: 1.5;
    }
    header {
      background-color: #2874f0;
      color: white;
      padding: 18px 24px;
      font-size: 24px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgb(40 116 240 / 0.3);
      user-select: none;
    }
    main {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 32px;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 24px 28px;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      margin-bottom: 32px;
      transition: box-shadow 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 4px 14px rgb(0 0 0 / 0.15);
    }
    h2 {
      margin-top: 0;
      font-weight: 700;
      font-size: 22px;
      color: #222;
      border-bottom: 2px solid #2874f0;
      padding-bottom: 8px;
      margin-bottom: 20px;
      user-select: none;
    }
    label {
      display: block;
      font-weight: 600;
      margin-top: 16px;
      margin-bottom: 6px;
      color: #444;
      user-select: none;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px 14px;
      font-size: 15px;
      border: 1.8px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.2s ease;
      font-family: inherit;
      color: #222;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #2874f0;
      box-shadow: 0 0 8px rgb(40 116 240 / 0.3);
    }
    textarea {
      resize: vertical;
      min-height: 72px;
    }
    button {
      margin-top: 24px;
      background-color: #fb641b;
      border: none;
      color: white;
      font-weight: 700;
      font-size: 17px;
      padding: 14px 28px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.25s ease;
    }
    button:hover {
      background-color: #d35400;
    }
    button.cancel {
      background: #777;
      margin-left: 10px;
    }
    button.cancel:hover {
      background: #555;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
      font-size: 15px;
      user-select: none;
    }
    th, td {
      padding: 14px 18px;
      text-align: left;
      vertical-align: middle;
    }
    thead th {
      background-color: #2874f0;
      color: white;
      font-weight: 700;
      border-radius: 10px 10px 0 0;
      user-select: none;
    }
    tbody tr {
      background-color: white;
      box-shadow: 0 1px 6px rgb(0 0 0 / 0.07);
      border-radius: 10px;
      transition: background-color 0.15s ease;
    }
    tbody tr:hover {
      background-color: #f3f7ff;
    }
    tbody tr td:first-child {
      border-radius: 10px 0 0 10px;
    }
    tbody tr td:last-child {
      border-radius: 0 10px 10px 0;
    }
    img {
      border-radius: 6px;
      max-width: 60px;
      max-height: 40px;
      object-fit: contain;
      box-shadow: 0 0 4px rgb(0 0 0 / 0.1);
    }
    select.order-status {
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1.4px solid #999;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }
    select.order-status:hover {
      border-color: #2874f0;
      box-shadow: 0 0 8px rgb(40 116 240 / 0.2);
    }
    button.edit-btn {
      background: #2874f0;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button.edit-btn:hover {
      background: #1a52c0;
    }
    @media (max-width: 640px) {
      h2 {
        font-size: 18px;
      }
      button {
        width: 100%;
      }
      button.cancel {
        width: auto;
        margin-left: 0;
        margin-top: 8px;
      }
      thead th, tbody td {
        padding: 10px 8px;
      }
      img {
        max-width: 45px;
        max-height: 30px;
      }
    }
  </style>
</head>
<body>

<header>Banerjee Mart - Admin Panel</header>

<main>

  <section class="card" aria-label="Add or edit product form">
    <h2 id="formTitle">Add Product</h2>
    <form id="productForm">
      <label for="name">Product Name</label>
      <input id="name" type="text" autocomplete="off" required />

      <label for="price">Price (â‚¹)</label>
      <input id="price" type="number" min="0" step="0.01" required />

      <label for="category">Category</label>
      <select id="category" required>
        <option value="">Select Category</option>
        <option value="Groceries">Groceries</option>
        <option value="Foods">Foods</option>
        <option value="Stationery">Stationery</option>
        <option value="Health">Health</option>
      </select>

      <label for="imageFileName">Image File Name (e.g., productname.png)</label>
      <input id="imageFileName" type="text" autocomplete="off" placeholder="e.g., rice.jpg" required />

      <label for="description">Description</label>
      <textarea id="description" rows="3" placeholder="Optional"></textarea>

      <label for="deal">Deal of the Day?</label>
      <select id="deal">
        <option value="">No</option>
        <option value="Deal of the Day">Yes</option>
      </select>

      <label for="trending">Trending?</label>
      <select id="trending">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>

      <button type="submit" id="submitBtn" aria-label="Add product">Add Product</button>
      <button type="button" id="cancelBtn" class="cancel" style="display:none;">Cancel</button>
    </form>
  </section>

  <section class="card" aria-label="Product list table">
    <h2>Product List</h2>
    <table role="table" aria-describedby="productTableDesc">
      <thead>
        <tr>
          <th scope="col">Name</th>
          <th scope="col">Price</th>
          <th scope="col">Category</th>
          <th scope="col">Image</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody id="productTable" role="rowgroup"></tbody>
    </table>
    <p id="productTableDesc" class="sr-only">List of products in your store</p>
  </section>

  <section class="card" aria-label="Orders list table">
    <h2>Orders</h2>
    <table role="table" aria-describedby="orderTableDesc">
      <thead>
        <tr>
          <th scope="col">Order ID</th>
          <th scope="col">Customer</th>
          <th scope="col">Items</th>
          <th scope="col">Status</th>
        </tr>
      </thead>
      <tbody id="orderTable" role="rowgroup"></tbody>
    </table>
    <p id="orderTableDesc" class="sr-only">List of customer orders</p>
  </section>

</main>

<!-- Firebase SDKs (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, orderBy,
    doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBbBiAnCjdEcv2PdTRGDuI_eDnTfnnK8g8",
    authDomain: "banerjee-mart.firebaseapp.com",
    projectId: "banerjee-mart",
    storageBucket: "banerjee-mart.firebasestorage.app",
    messagingSenderId: "183628570952",
    appId: "1:183628570952:web:3028bb258001d004d9537d"
  };

  // Initialize Firebase app and Firestore
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Base URL for product images
  const baseImageUrl = "https://raw.githubusercontent.com/Swarup2024web/Tester/main/assets/";

  // Elements
  const productForm = document.getElementById("productForm");
  const productTable = document.getElementById("productTable");
  const orderTable = document.getElementById("orderTable");
  const formTitle = document.getElementById("formTitle");
  const submitBtn = document.getElementById("submitBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  // State for editing
  let editingProductId = null;

  // Add or update product event handler
  productForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = productForm.name.value.trim();
    const price = parseFloat(productForm.price.value);
    const category = productForm.category.value;
    const imageFileName = productForm.imageFileName.value.trim();
    const description = productForm.description.value.trim();
    const deal = productForm.deal.value || null;
    const trending = productForm.trending.value === "true";

    if (!imageFileName) {
      alert("Please enter an image file name.");
      return;
    }

    const imageUrl = baseImageUrl + encodeURIComponent(imageFileName);

    const productData = {
      name,
      price,
      category,
      imageUrl,
      description,
      deal,
      trending,
      createdAt: editingProductId ? undefined : new Date()
    };

    try {
      if (editingProductId) {
        // Update existing product
        const productRef = doc(db, "products", editingProductId);
        // Remove createdAt on update to keep original timestamp
        delete productData.createdAt;
        await updateDoc(productRef, productData);
        alert("Product updated successfully!");
      } else {
        // Add new product
        await addDoc(collection(db, "products"), productData);
        alert("Product added successfully!");
      }

      resetForm();
      loadProducts();
    } catch (error) {
      alert("Failed to save product: " + error.message);
    }
  });

  // Cancel edit button handler
  cancelBtn.addEventListener("click", () => {
    resetForm();
  });

  // Reset form to add mode
  function resetForm() {
    editingProductId = null;
    productForm.reset();
    formTitle.textContent = "Add Product";
    submitBtn.textContent = "Add Product";
    cancelBtn.style.display = "none";
  }

  // Load products from Firestore and display with edit buttons
  async function loadProducts() {
    productTable.innerHTML = "";
    try {
      const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        productTable.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#666;">No products found.</td></tr>`;
        return;
      }
      querySnapshot.forEach((docSnap) => {
        const p = docSnap.data();
        productTable.innerHTML += `
          <tr>
            <td>${p.name}</td>
            <td>â‚¹${p.price.toFixed(2)}</td>
            <td>${p.category}</td>
            <td><img src="${p.imageUrl}" alt="${p.name}" loading="lazy" /></td>
            <td>
              <button class="edit-btn" data-id="${docSnap.id}">Edit</button>
            </td>
          </tr>
        `;
      });

      // Attach event listeners for all edit buttons
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          startEditing(btn.dataset.id);
        });
      });
    } catch (error) {
      productTable.innerHTML = `<tr><td colspan="5" style="color:red;">Error loading products: ${error.message}</td></tr>`;
    }
  }

  // Load orders from Firestore and display
  async function loadOrders() {
    orderTable.innerHTML = "";
    try {
      const querySnapshot = await getDocs(collection(db, "orders"));
      if (querySnapshot.empty) {
        orderTable.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#666;">No orders found.</td></tr>`;
        return;
      }
      querySnapshot.forEach((docSnap) => {
        const o = docSnap.data();
        const statusSelect = `
          <select class="order-status" onchange="updateOrderStatus('${docSnap.id}', this.value)" aria-label="Change status for order ${docSnap.id}">
            <option value="Pending" ${o.status === "Pending" ? "selected" : ""}>Pending</option>
            <option value="Shipped" ${o.status === "Shipped" ? "selected" : ""}>Shipped</option>
            <option value="Delivered" ${o.status === "Delivered" ? "selected" : ""}>Delivered</option>
            <option value="Cancelled" ${o.status === "Cancelled" ? "selected" : ""}>Cancelled</option>
          </select>
        `;
        orderTable.innerHTML += `
          <tr>
            <td>${docSnap.id}</td>
            <td>${o.customerName || "N/A"}</td>
            <td>${(o.items || []).map(i => i.name).join(", ")}</td>
            <td>${statusSelect}</td>
          </tr>
        `;
      });
    } catch (error) {
      orderTable.innerHTML = `<tr><td colspan="4" style="color:red;">Error loading orders: ${error.message}</td></tr>`;
    }
  }

  // Start editing a product by ID: fill form with its data
  async function startEditing(productId) {
    try {
      const productRef = doc(db, "products", productId);
      const docSnap = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js").then(({ getDoc }) => getDoc(productRef));
      if (!docSnap.exists()) {
        alert("Product not found!");
        return;
      }
      const p = docSnap.data();

      editingProductId = productId;
      formTitle.textContent = "Edit Product";
      submitBtn.textContent = "Update Product";
      cancelBtn.style.display = "inline-block";

      productForm.name.value = p.name || "";
      productForm.price.value = p.price || "";
      productForm.category.value = p.category || "";
      // Extract image filename from full URL (last segment)
      const urlParts = p.imageUrl?.split("/") || [];
      productForm.imageFileName.value = urlParts.length ? decodeURIComponent(urlParts[urlParts.length - 1]) : "";
      productForm.description.value = p.description || "";
      productForm.deal.value = p.deal || "";
      productForm.trending.value = p.trending ? "true" : "false";
    } catch (error) {
      alert("Failed to load product for editing: " + error.message);
    }
  }

  // Update order status function exposed to window
  window.updateOrderStatus = async function (orderId, newStatus) {
    try {
      const orderRef = doc(db, "orders", orderId);
      await updateDoc(orderRef, { status: newStatus });
      alert(`Order ${orderId} status updated to "${newStatus}"`);
    } catch (error) {
      alert("Failed to update order status: " + error.message);
    }
  };

  // On page load
  loadProducts();
  loadOrders();

</script>

</body>
  </html>
