<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Banerjee Mart Admin Panel</title>
  <style>
    /* Global Reset and Variables */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    :root {
      --primary-color: #232f3e;
      --secondary-color: #febd69;
      --accent-color: #f7a600;
      --text-color-dark: #111;
      --text-color-light: #fff;
      --bg-color-main: #eaeded;
      --bg-color-card: #fff;
      --border-color: #ddd;
      --shadow: 0 2px 5px rgba(0,0,0,0.1);
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      margin: 0;
      font-family: var(--font-family);
      background-color: var(--bg-color-main);
      color: var(--text-color-dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      background-color: var(--primary-color);
      color: var(--text-color-light);
      font-size: 1.8rem;
      font-weight: 700;
      padding: 20px 32px;
      user-select: none;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.25);
    }

    /* Main Content and Layout */
    main {
      flex-grow: 1;
      max-width: 1280px;
      margin: 24px auto;
      padding: 0 20px 40px;
      width: 100%;
    }
    
    .dashboard-grid {
      display: grid;
      gap: 24px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px) {
      .dashboard-grid {
        grid-template-columns: 1fr 2fr;
      }
    }

    /* Section Titles */
    h2 {
      margin-top: 0;
      font-weight: 700;
      font-size: 1.6rem;
      color: var(--primary-color);
      padding-bottom: 8px;
      border-bottom: 3px solid var(--secondary-color);
      user-select: none;
    }
    
    /* Form Styling */
    form {
      background-color: var(--bg-color-card);
      border: 1px solid var(--border-color);
      padding: 24px 30px;
      border-radius: var(--border-radius, 8px);
      box-shadow: var(--shadow);
      margin-bottom: 36px;
    }
    label {
      display: block;
      margin-top: 18px;
      font-weight: 600;
      color: var(--primary-color);
      user-select: none;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px 14px;
      margin-top: 6px;
      font-size: 1rem;
      border: 1.8px solid var(--border-color);
      border-radius: 6px;
      transition: border-color 0.25s ease, box-shadow 0.25s ease;
      font-family: var(--font-family);
      color: var(--text-color-dark);
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 5px var(--secondary-color);
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Buttons */
    button {
      background-color: var(--secondary-color);
      border: none;
      font-weight: 700;
      font-size: 1.1rem;
      padding: 14px 28px;
      margin-top: 28px;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      color: var(--text-color-dark);
      transition: background-color 0.3s ease;
      width: 100%;
    }
    button:hover {
      background-color: var(--accent-color);
    }
    button.cancel {
      background-color: #ddd;
      color: #333;
      margin-top: 12px;
      width: 100%;
    }
    button.cancel:hover {
      background-color: #bbb;
    }

    /* Table Styling */
    .table-container {
      overflow-x: auto;
      background-color: var(--bg-color-card);
      border-radius: 8px;
      box-shadow: var(--shadow);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
    }
    thead th {
      background-color: var(--primary-color);
      color: var(--secondary-color);
      font-weight: 700;
      text-align: left;
      padding: 12px 16px;
      user-select: none;
    }
    thead th:first-child { border-radius: 8px 0 0 0; }
    thead th:last-child { border-radius: 0 8px 0 0; }
    tbody tr {
      background-color: var(--bg-color-card);
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.2s ease;
    }
    tbody tr:last-child {
      border-bottom: none;
    }
    tbody tr:hover {
      background-color: #fef4d4;
    }
    tbody td {
      padding: 14px 16px;
      vertical-align: middle;
      color: var(--primary-color);
    }
    tbody td img {
      max-width: 80px;
      max-height: 50px;
      object-fit: contain;
      border-radius: 6px;
      box-shadow: 0 0 5px rgb(0 0 0 / 0.05);
    }
    
    /* Action Buttons and Status Select */
    button.edit-btn {
      background-color: var(--secondary-color);
      border: none;
      color: var(--primary-color);
      font-weight: 700;
      padding: 6px 14px;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    button.edit-btn:hover {
      background-color: var(--accent-color);
    }
    select.order-status {
      padding: 6px 12px;
      border-radius: 5px;
      border: 1.5px solid #ccc;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--primary-color);
      cursor: pointer;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    select.order-status:hover {
      border-color: var(--secondary-color);
      box-shadow: 0 0 8px rgba(254, 189, 105, 0.4);
    }

    /* Responsive adjustments */
    @media (max-width: 720px) {
      main {
        padding: 0 12px 32px;
      }
      form {
        max-width: 100%;
      }
      table {
        font-size: 0.9rem;
      }
      tbody td img {
        max-width: 60px;
        max-height: 38px;
      }
      thead th, tbody td {
        padding: 10px;
      }
    }
  </style>
</head>
<body>

<header>Banerjee Mart Admin Panel</header>

<main>
  <div class="dashboard-grid">
    <section aria-label="Add or edit product form">
      <h2 id="formTitle">Add Product</h2>
      <form id="productForm" novalidate>
        <label for="name">Product Name</label>
        <input id="name" name="name" type="text" autocomplete="off" required />

        <label for="price">Price (â‚¹)</label>
        <input id="price" name="price" type="number" min="0" step="0.01" required />

        <label for="category">Category</label>
        <select id="category" name="category" required>
          <option value="" disabled selected>Select Category</option>
          <option value="Groceries">Groceries</option>
          <option value="Foods">Foods</option>
          <option value="Stationery">Stationery</option>
          <option value="Health">Health</option>
        </select>

        <label for="imageFileName">Image File Name (e.g., productname.png)</label>
        <input id="imageFileName" name="imageFileName" type="text" autocomplete="off" placeholder="e.g., rice.png" required />

        <label for="description">Description</label>
        <textarea id="description" name="description" placeholder="Optional"></textarea>

        <label for="deal">Deal of the Day?</label>
        <select id="deal" name="deal">
          <option value="" selected>No</option>
          <option value="Deal of the Day">Yes</option>
        </select>

        <label for="trending">Trending?</label>
        <select id="trending" name="trending" required>
          <option value="false" selected>No</option>
          <option value="true">Yes</option>
        </select>

        <button type="submit" id="submitBtn" aria-label="Add product">Add Product</button>
        <button type="button" id="cancelBtn" class="cancel" style="display:none;">Cancel Edit</button>
      </form>
    </section>

    <section aria-label="Product list and orders">
      <h2 style="margin-top: 0;">Product List</h2>
      <div class="table-container">
        <table aria-describedby="productTableDesc">
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Price</th>
              <th scope="col">Category</th>
              <th scope="col">Image</th>
              <th scope="col" style="width: 110px;">Actions</th>
            </tr>
          </thead>
          <tbody id="productTable"></tbody>
        </table>
        <p id="productTableDesc" class="sr-only">List of products added in the store.</p>
      </div>

      <h2 style="margin-top: 40px;">Orders</h2>
      <div class="table-container">
        <table aria-describedby="orderTableDesc">
          <thead>
            <tr>
              <th scope="col">Order ID</th>
              <th scope="col">Customer</th>
              <th scope="col">Items</th>
              <th scope="col" style="width: 140px;">Status</th>
            </tr>
          </thead>
          <tbody id="orderTable"></tbody>
        </table>
        <p id="orderTableDesc" class="sr-only">List of customer orders and their statuses.</p>
      </div>
    </section>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs, query, orderBy,
    doc, updateDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBbBiAnCjdEcv2PdTRGDuI_eDnTfnnK8g8",
    authDomain: "banerjee-mart.firebaseapp.com",
    projectId: "banerjee-mart",
    storageBucket: "banerjee-mart.firebasestorage.app",
    messagingSenderId: "183628570952",
    appId: "1:183628570952:web:3028bb258001d004d9537d"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const baseImageUrl = "https://raw.githubusercontent.com/Swarup2024web/Tester/main/assets/";

  // DOM elements
  const productForm = document.getElementById("productForm");
  const productTable = document.getElementById("productTable");
  const orderTable = document.getElementById("orderTable");
  const formTitle = document.getElementById("formTitle");
  const submitBtn = document.getElementById("submitBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  let editingProductId = null;

  productForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(productForm);
    const name = formData.get("name").trim();
    const price = parseFloat(formData.get("price"));
    const category = formData.get("category");
    const imageFileName = formData.get("imageFileName").trim();
    const description = formData.get("description").trim();
    const deal = formData.get("deal") || null;
    const trending = formData.get("trending") === "true";

    if (!imageFileName) {
      alert("Please enter an image file name.");
      return;
    }

    const imageUrl = baseImageUrl + encodeURIComponent(imageFileName);

    const productData = {
      name,
      price,
      category,
      imageUrl,
      description,
      deal: deal === "Deal of the Day" ? true : false,
      trending,
      createdAt: editingProductId ? undefined : new Date()
    };

    try {
      if (editingProductId) {
        const productRef = doc(db, "products", editingProductId);
        delete productData.createdAt;
        await updateDoc(productRef, productData);
        alert("Product updated successfully!");
      } else {
        await addDoc(collection(db, "products"), productData);
        alert("Product added successfully!");
      }
      resetForm();
      loadProducts();
    } catch (error) {
      alert("Failed to save product: " + error.message);
    }
  });

  cancelBtn.addEventListener("click", () => {
    resetForm();
  });

  function resetForm() {
    editingProductId = null;
    productForm.reset();
    formTitle.textContent = "Add Product";
    submitBtn.textContent = "Add Product";
    cancelBtn.style.display = "none";
  }

  async function loadProducts() {
    productTable.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#666;">Loading products...</td></tr>`;
    try {
      const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
      const querySnapshot = await getDocs(q);
      productTable.innerHTML = "";
      if (querySnapshot.empty) {
        productTable.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#666;">No products found.</td></tr>`;
        return;
      }
      querySnapshot.forEach((docSnap) => {
        const p = docSnap.data();
        productTable.innerHTML += `
          <tr>
            <td>${p.name}</td>
            <td>â‚¹${p.price.toFixed(2)}</td>
            <td>${p.category}</td>
            <td><img src="${p.imageUrl}" alt="${p.name}" loading="lazy" /></td>
            <td><button class="edit-btn" data-id="${docSnap.id}" aria-label="Edit product ${p.name}">Edit</button></td>
          </tr>
        `;
      });
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          startEditing(btn.dataset.id);
        });
      });
    } catch (error) {
      productTable.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">Error loading products: ${error.message}</td></tr>`;
    }
  }

  async function startEditing(productId) {
    try {
      const productRef = doc(db, "products", productId);
      const docSnap = await getDoc(productRef);
      if (!docSnap.exists()) {
        alert("Product not found!");
        return;
      }
      const p = docSnap.data();

      editingProductId = productId;
      formTitle.textContent = "Edit Product";
      submitBtn.textContent = "Update Product";
      cancelBtn.style.display = "block";

      productForm.name.value = p.name || "";
      productForm.price.value = p.price || "";
      productForm.category.value = p.category || "";
      const urlParts = p.imageUrl?.split("/") || [];
      productForm.imageFileName.value = urlParts.length ? decodeURIComponent(urlParts[urlParts.length - 1]) : "";
      productForm.description.value = p.description || "";
      productForm.deal.value = p.deal === true ? "Deal of the Day" : "";
      productForm.trending.value = p.trending ? "true" : "false";
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (error) {
      alert("Failed to load product for editing: " + error.message);
    }
  }

  async function loadOrders() {
    orderTable.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#666;">Loading orders...</td></tr>`;
    try {
      const querySnapshot = await getDocs(collection(db, "orders"));
      orderTable.innerHTML = "";
      if (querySnapshot.empty) {
        orderTable.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#666;">No orders found.</td></tr>`;
        return;
      }
      querySnapshot.forEach((docSnap) => {
        const o = docSnap.data();
        const itemsList = (o.items || []).map(i => i.name).join(", ");
        const statusOptions = ["Pending", "Shipped", "Delivered", "Cancelled"]
          .map(s => `<option value="${s}" ${o.status === s ? "selected" : ""}>${s}</option>`).join("");
        orderTable.innerHTML += `
          <tr>
            <td>${docSnap.id}</td>
            <td>${o.customerName || "N/A"}</td>
            <td>${itemsList}</td>
            <td>
              <select class="order-status" aria-label="Change status for order ${docSnap.id}" data-id="${docSnap.id}">
                ${statusOptions}
              </select>
            </td>
          </tr>
        `;
      });
      document.querySelectorAll(".order-status").forEach(sel => {
        sel.addEventListener("change", async () => {
          const orderId = sel.dataset.id;
          const newStatus = sel.value;
          try {
            const orderRef = doc(db, "orders", orderId);
            await updateDoc(orderRef, { status: newStatus });
            alert(`Order ${orderId} status updated to "${newStatus}"`);
          } catch (error) {
            alert("Failed to update order status: " + error.message);
          }
        });
      });
    } catch (error) {
      orderTable.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">Error loading orders: ${error.message}</td></tr>`;
    }
  }

  // Initial load
  document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
    loadOrders();
  });
</script>

</body>
</html>
